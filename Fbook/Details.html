<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Source details</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --clr-primary: #3498db;
      --clr-bg-accent: #006666;
      --clr-tooltip: #669999;
      --clr-text: #fff;
      --font-body: "Arial", sans-serif;
      --font-heading: "Verdana", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 1rem;
      background: #000;
      color: var(--clr-text);
      font-family: var(--font-body);
      line-height: 1.4;
    }

    #surveyMessage {
      font: 14px var(--font-heading);
    }

    #secondMessage {
      font: 13px var(--font-body);
    }

    #resultOutput {
      margin-top: 0.5rem;
      padding: 10px;
      background: transparent;
      border: 0;
      max-height: 250px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      font: 13px var(--font-body);
    }

    .spinner {
      display: none;
      width: 40px;
      height: 40px;
      border: 6px solid #f3f3f3;
      border-top: 6px solid var(--clr-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    .spinner.is-visible {
      display: block;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 999;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .tooltip {
      margin-top: 10px;
      position: relative;
      display: inline-block;
      cursor: pointer;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      width: 180px;
      padding: 6px;
      background: var(--clr-tooltip);
      color: var(--clr-text);
      text-align: center;
      border-radius: 6px;
      font: 11px var(--font-heading);
      z-index: 1;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
    }

    button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background: var(--clr-primary);
      color: var(--clr-text);
      font: 14px var(--font-body);
      cursor: pointer;
    }

    button:hover,
    button:focus-visible {
      background: #2178b8;
    }
  </style>
</head>

<body>
  <main aria-live="polite">
    <section id="messages">
      <div id="surveyMessage"></div>
      <div id="secondMessage"></div>
    </section>

    <div id="resultOutput"></div>

    <div id="spinner" class="spinner" role="status" aria-hidden="true"></div>

    <div class="tooltip">
      <span id="tooltipText" class="tooltiptext"></span>
      <button onclick="changeBackground('--clr-bg-accent'); runRemoteScript()">Detailed info</button>
    </div>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const sourceName = params.get("source") || "my source";
    const language = params.get("lang") || "English";
    const requestedSurvey = params.get("survey") || "DSS2";
    const requestedItem = params.get("item") || "";

    function getEnergyBand(survey) {
      const bands = {
        optical: ["PanSTARRS", "SDSS9", "DESI", "ZTF"],
        infrared: ["allWISE", "unWISE", "2MASS"],
        "X-ray": ["RASS", "XMM-EPIC", "Chandra"],
        "γ-ray": ["Fermi-LAT"],
        Ultraviolet: ["GALEXGR6_7"]
      };
      return Object.entries(bands)
        .find(([, list]) => list.includes(survey))?.[0] || "";
    }
    const energyBand = getEnergyBand(requestedSurvey);

    function changeBackground(cssVar) {
      document.getElementById("resultOutput").style.background = `var(${cssVar})`;
    }

    /* ---------- remote fetch ---------- */
    async function runRemoteScript() {
      const spinner = document.getElementById("spinner");
      const output = document.getElementById("resultOutput");

      spinner.classList.add("is-visible");
      output.textContent = "⏳ Asking AI, please wait...";

      const payload = {
        question: `Tell me in brief what you know about the astronomical source named ${sourceName}`,
        language
      };

      try {
        const res = await fetch(
          "https://firmamento-nyuad-25ebad56567d.herokuapp.com/fbook",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          }
        );
        output.textContent = await res.text();
      } catch (err) {
        console.error(err);
        output.textContent = "⚠️ Failed to load content.";
      } finally {
        spinner.classList.remove("is-visible");
      }
    }

    /* ---------- initial render ---------- */
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("secondMessage").innerHTML = `
        <br>This page will show a table of sources similar
        <br>to <span style="color:#ff9966;">${sourceName}</span> and links to the Firmamento data section
        <br>to explore or analyze multi‑frequency and time‑domain data.`;

      document.getElementById("tooltipText").textContent =
        `Clicking here will return detailed info for ${sourceName} via a call to an AI server`;
    });
  </script>
</body>

</html>